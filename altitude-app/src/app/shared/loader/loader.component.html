<div class="loader-wrapper">
    <!-- Animated border that circles around -->
    <div class="spinning-border"></div>

    <!-- Background Video with Black Overlay -->
    <div class="video-background">
        <video src="assets/videos/dark-particles.mp4" autoplay muted loop playsinline class="video-element"></video>
        <!-- Black translucent overlay -->
        <div class="video-overlay"></div>
    </div>

    <!-- Scrollable Content Container -->
    <div class="content-wrapper">
        <!-- Centered Content with Heading, Workflow, and Loader -->
        <div class="content-inner">
            <!-- Heading Section -->
            <div class="mb-6 text-center">
                <h1 class="text-center text-[2.5rem]">Creating <span class="email-glow italic">Magic!</span></h1>
            </div>

            <!-- Agentic Workflow Section -->
            <div class="workflow-container mb-6 w-full max-w-[400px] px-4">
                <!-- Skeleton Loader when no agents are received -->
                <div *ngIf="getWorkflowAgents().length === 0" class="skeleton-loader space-y-4">
                    <div *ngFor="let item of [1,2,3,4]" class="skeleton-agent-card">
                        <div class="skeleton-shimmer"></div>
                    </div>
                </div>

                <!-- Actual Workflow when agents are available -->
                <svg *ngIf="getWorkflowAgents().length > 0" class="workflow-svg" width="100%"
                    [attr.height]="getWorkflowHeight()" [attr.viewBox]="'0 0 450 ' + getWorkflowHeight()">
                    <defs>
                        <!-- Arrow markers -->
                        <marker id="arrowGreen" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"
                            markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L6,3 z" fill="#22c55e" />
                        </marker>
                        <marker id="arrowYellow" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"
                            markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L6,3 z" fill="#eab308" />
                        </marker>
                        <marker id="arrowGray" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"
                            markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L6,3 z" fill="#6b7280" />
                        </marker>
                    </defs>

                    <!-- Workflow nodes and connections -->
                    <ng-container *ngFor="let agent of getWorkflowAgents(); let i = index">
                        <!-- Connection line from previous node -->
                        <ng-container *ngIf="i > 0">
                            <line [attr.x1]="225" [attr.y1]="60 + (i - 1) * 110 + 60" [attr.x2]="225"
                                [attr.y2]="60 + i * 110"
                                [attr.stroke]="getLineColor(agent.status, agent.previousStatus || 'PENDING')"
                                [attr.stroke-width]="2"
                                [attr.stroke-dasharray]="shouldShowDashedLine(agent.status, agent.previousStatus || 'PENDING') ? '8,4' : '0'"
                                [attr.marker-end]="getMarkerUrl(agent.status, agent.previousStatus || 'PENDING')"
                                [class.animated-dashes]="shouldShowDashedLine(agent.status, agent.previousStatus || 'PENDING')" />
                        </ng-container>

                        <!-- Agent node -->
                        <g [attr.transform]="'translate(75, ' + (60 + i * 110) + ')'">
                            <!-- Main rectangle with conditional border -->
                            <rect x="0" y="0" width="300" height="60" rx="10" [attr.fill]="getNodeColor(agent.status)"
                                [attr.stroke]="agent.status === 'COMPLETED' ? '#b66dff' : '#4a5568'"
                                [attr.stroke-width]="agent.status === 'COMPLETED' ? '2' : '1'"
                                [attr.class]="getBorderClass(agent.status)" />

                            <!-- Border animation for IN_PROGRESS (rotating border around all 4 sides) -->
                            <rect *ngIf="showBorderAnimation(agent.status)" x="0" y="0" width="300" height="60" rx="10"
                                fill="none" stroke="#9a62e1" stroke-width="3" class="border-animation" />

                            <!-- Status dot (only for COMPLETED) -->
                            <circle *ngIf="showStatusDot(agent.status)" [attr.cx]="15" [attr.cy]="30" r="5"
                                [attr.fill]="getStatusIconColor(agent.status)" />

                            <!-- Agent name -->
                            <text x="30" y="22" fill="#fff" font-size="14" font-weight="600">
                                <tspan>{{ agent.name.length > 25 ? (agent.name | titlecase | slice:0:25) + '...' :
                                    (agent.name | titlecase) }}</tspan>
                            </text>

                            <!-- Dynamic message from socket (wrapped and truncated) -->
                            <text x="30" y="37" [attr.fill]="getStatusTextColor(agent.status)" font-size="11"
                                font-style="italic">
                                <tspan>{{ getAgentMessage(agent).length > 35 ? getAgentMessage(agent).slice(0, 35) +
                                    '...' : getAgentMessage(agent) }}</tspan>
                            </text>

                            <!-- Status badge and time -->
                            <text x="30" y="50" fill="#9ca3af" font-size="9">
                                <tspan>{{ agent.status }} â€¢ {{ agent.updatedAt }}</tspan>
                            </text>
                        </g>
                    </ng-container>
                </svg>
            </div>
        </div>
    </div>
</div>